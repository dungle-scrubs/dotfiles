#!/usr/bin/env lua
---
--- SketchyBar Configuration Entry Point
--- Main configuration file for SketchyBar using SbarLua bindings.
--- Loads color palette, shared styles, and individual bar items.
---
--- @see https://felixkratz.github.io/SketchyBar/
--- @see https://github.com/FelixKratz/SbarLua
---

--- Resolve SbarLua shared library path for different install locations
---@type string
local user = os.getenv("USER") or ""

---@type string[]
local lua_paths = {
  "/Users/" .. user .. "/.local/share/sketchybar_lua/?.so",
  "/opt/homebrew/share/sketchybar_lua/?.so",
  "/usr/local/share/sketchybar_lua/?.so",
}

for _, path in ipairs(lua_paths) do
  package.cpath = package.cpath .. ";" .. path
end

---@type SbarLua
local sbar = require("sketchybar")

---@type string
local config_dir = os.getenv("CONFIG_DIR") or ("/Users/" .. user .. "/.config/sketchybar")

-- Add module paths for colors, styles, and items
package.path = package.path .. ";" .. config_dir .. "/?.lua"
package.path = package.path .. ";" .. config_dir .. "/items/?.lua"

---@type ColorPalette
local colors = require("colors")

---@type Styles
local styles = require("styles")

---@type fun(color: integer): string
local c = styles.c

-- Bar configuration: top position, 34px height, base color background
sbar.bar({
  position = "top",
  height = 34,
  color = c(colors.base),
  padding_left = 8,
  padding_right = 8,
})

-- Default item settings: fonts, colors, padding
sbar.default({
  icon = {
    font = styles.fonts.icon,
    color = c(colors.text),
    padding_right = 4,
  },
  label = {
    font = styles.fonts.text,
    color = c(colors.text),
    padding_left = 4,
  },
  padding_left = 6,
  padding_right = 6,
})

---
--- Closes all popup menus.
--- Called by items that need mutual exclusion of popups.
---
---@return nil
local function close_popups()
  sbar.exec("sketchybar --set apple popup.drawing=off --set api_usage popup.drawing=off --set docker popup.drawing=off --set releases popup.drawing=off --set wifi popup.drawing=off")
end

-- Load items (order matters for positioning: left items first, then right)
require("apple")(sbar, colors, styles)
require("front_app")(sbar, colors, styles, close_popups)
require("workspace")(sbar, colors, styles, close_popups)
require("system_stats")(sbar, colors, styles)
require("api_usage")(sbar, colors, styles)
require("docker")(sbar, colors, styles)
require("releases")(sbar, colors, styles)
require("datetime")(sbar, colors, styles, close_popups)
require("wifi")(sbar, colors, styles, close_popups)
require("battery")(sbar, colors, styles, close_popups)
require("volume")(sbar, colors, styles, close_popups)
require("animator")(sbar, colors, styles)

-- Start the event loop (blocks forever)
sbar.event_loop()
